#!/opt/homebrew/bin/bash

# Global Vars
MODULE_NAME="PRE_DISBURSAL"
WFC_NAME_PREFIX="default"

pd_workflow_config() {
	local source_entity_id="$1"
	local organization_id="$2"
	local program_name="$3"
	local lender_id="$4"

	# UUID for config_id and JSON ID
	config_id=$(uuidgen | tr '[:upper:]' '[:lower:]')

	# Compose workflow_definition JSON for PRE_DISBURSAL module
	read -r -d '' workflow_config_json <<EOM
{
  "id": "$config_id",
  "name": "${WFC_NAME_PREFIX}_pre_disbursal",
  "start": "ValidateUnderwritingPreDisbursal",
  "states": [
    {
      "end": true,
      "name": "ValidateUnderwritingPreDisbursal",
      "type": "operation",
      "actions": [
        {
          "functionRef": {
            "refName": "ValidateUnderwritingPreDisbursal",
            "arguments": {}
          }
        }
      ],
      "metadata": {
        "moduleNameTag": "PRE_DISBURSAL",
        "subModuleNameTag": "WAIT"
      }
    }
  ],
  "version": "1.0.0",
  "specVersion": "0.0.1"
}
EOM

	insert-workflow-config \
		--config_id "$config_id" \
		--source_entity_id "$source_entity_id" \
		--lender_id "$lender_id" \
		--organization_id "$organization_id" \
		--program_name "$program_name" \
		--module_name "$MODULE_NAME" \
		--workflow_definition "$workflow_config_json" \
		--skip-update
}

pd_wait_section_config() {
	local source_entity_id="$1"
	local organization_id="$2"
	local program_name="$3"

	# UUID for config_id and JSON ID
	config_id=$(uuidgen | tr '[:upper:]' '[:lower:]')

	# Compose section_data JSON for WAIT page
	read -r -d '' section_data <<EOM
{
  "key": "WAIT",
  "sections": [
    {
      "key": "wait",
      "type": "page",
      "title": "",
      "sequence": 0,
      "components": [
        {
          "type": "wait",
          "fields": []
        }
      ],
      "description": ""
    }
  ]
}
EOM

	insert-section-config \
		--config_id "$config_id" \
		--source_entity_id "$source_entity_id" \
		--organization_id "$organization_id" \
		--program_name "$program_name" \
		--module_name "$MODULE_NAME" \
		--sub_module_name "WAIT" \
		--section_data "$section_data" \
		--skip-update
}

insert_pre_disbursal_module_jq() {
	local json="$1"
	echo "$json" | jq '
	.modules |= (
	  if any(.[]; .moduleName == "ESIGN") and (all(.[]; .moduleName != "PRE_DISBURSAL")) then
	    map(
	      if .moduleName == "ESIGN" then
	        {"moduleName": "PRE_DISBURSAL", "moduleType": "POST_OFFER", "isActive": true},
	        .
	      else
	        .
	      end
	    )
	  else
	    .
	  end
	)'
}

escape_single_quotes() {
	perl -pe "s/(?<!')'(?!')/''/g"
}

insert_pre_disbursal_module_sql() {
	local workflow_id="$1"
	local modified_json="$2"
	local workflow_name="$3"
	local escaped_json

	# Escape single quotes in JSON for SQL
	escaped_json=$(echo "$modified_json" | escape_single_quotes)

	cat <<EOF
-- Add PRE_DISBURSAL module in $workflow_name
UPDATE workflow
SET workflow_data = '$escaped_json'
WHERE workflow_id = '$workflow_id';

EOF
}

call_redash() {
	local api_url="$1"
	local json_data

	json_data=$(curl -s -X GET "$api_url")

	if [ $? -ne 0 ]; then
		echo "❌ Error: Failed to fetch data from API"
		exit 1
	fi

	if echo "$json_data" | jq -e '.message == "No cached result found for this query."' >/dev/null; then
		echo "❌ Error: No cached result found for this query"
		exit 1
	fi

	echo "$json_data"
}

JSON_DATA=$(call_redash "https://redash.finbox.in/api/queries/5031/results.json?api_key=HB8KPPBokm1ma0KqoI1IohjtMlIhVNJxfcgBhZSJ")
while IFS= read -r row; do
	if [ -n "$row" ]; then
		workflow_id=$(echo "$row" | jq -r '.workflow_id')
		workflow_name=$(echo "$row" | jq -r '.workflow_name')
		workflow_data=$(echo "$row" | jq -r '.workflow_data')

		WFC_NAME_PREFIX=$(echo "$workflow_name" | cut -d'_' -f1)

		go_migration_output=$(go run cmd/sql/generate.go "-table=add_pre_disbursal_module_in_${workflow_name}" 2>&1)
		migration_file=$(echo "$go_migration_output" | gawk '{print $6}')

		workflow_data_with_pd_module=$(insert_pre_disbursal_module_jq "$workflow_data")
		insert_pre_disbursal_module_sql "$workflow_id" "$workflow_data_with_pd_module" "$workflow_name" >"$(pwd)/$migration_file"

		git add "$(pwd)/$migration_file"
		git commit -m "feat: added pre disbursal module in $workflow_name"

		echo "✅ Processed workflow: $workflow_name (ID: $workflow_id)"
	fi
done < <(echo "$JSON_DATA" | jq -c '.query_result.data.rows[]')
