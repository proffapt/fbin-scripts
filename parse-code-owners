#!/bin/bash
set -euo pipefail

# Branch prefix is mandatory
if [ "$#" -lt 1 ]; then
	echo "Usage: $0 <branch-prefix>"
	exit 1
fi

BRANCH_PREFIX="$1"

# Get changed files automatically
CHANGED_FILES=($(git diff --name-only))

if [ "${#CHANGED_FILES[@]}" -eq 0 ]; then
	echo "No staged/changed files found."
	exit 0
fi

CODEOWNERS_FILE=".github/CODEOWNERS"
if [ ! -f "$CODEOWNERS_FILE" ]; then
	echo "CODEOWNERS file not found at $CODEOWNERS_FILE"
	exit 1
fi

# Parse CODEOWNERS into arrays
PATTERNS=()
REVIEWERS=()

while IFS= read -r line; do
	[[ -z "$line" || "$line" =~ ^# ]] && continue
	pattern=$(echo "$line" | awk '{print $1}')
	reviewers=$(echo "$line" | awk '{$1=""; print $0}' | xargs)
	pattern=${pattern#./}
	if [[ "$pattern" != */ ]] && [ -d "$pattern" ]; then
		pattern="$pattern/"
	fi
	PATTERNS+=("$pattern")
	REVIEWERS+=("$reviewers")
done <"$CODEOWNERS_FILE"

# Function to find reviewers for a file
get_reviewers() {
	local file="$1"
	file=${file#./}
	for i in "${!PATTERNS[@]}"; do
		pattern=${PATTERNS[$i]}
		reviewers=${REVIEWERS[$i]}
		if [[ "$pattern" == */ ]]; then
			[[ "$file" == "$pattern"* ]] && {
				echo "$reviewers"
				return
			}
		else
			[[ "$file" == "$pattern" ]] && {
				echo "$reviewers"
				return
			}
		fi
	done
	echo "unassigned"
}

# Group files by reviewer set
PR_GROUPS=()
for f in "${CHANGED_FILES[@]}"; do
	reviewers=$(get_reviewers "$f" | tr ' ' '\n' | sort | tr '\n' ',' | sed 's/,$//')
	found=0
	for i in "${!PR_GROUPS[@]}"; do
		if [[ "${PR_GROUPS[$i]}" == "$reviewers|"* ]]; then
			PR_GROUPS[$i]="${PR_GROUPS[$i]} $f"
			found=1
			break
		fi
	done
	if [[ $found -eq 0 ]]; then
		PR_GROUPS+=("$reviewers|$f")
	fi
done

TOTAL_FILES=${#CHANGED_FILES[@]}

# Print plan
pr_num=1
for group in "${PR_GROUPS[@]}"; do
	reviewers="${group%%|*}"
	files="${group#*|}"
	files_array=($files)
	file_count=${#files_array[@]}
	echo "PR $pr_num ($file_count/$TOTAL_FILES files):"
	echo "  Reviewers: $reviewers"
	echo "  Files:"
	for file in "${files_array[@]}"; do
		echo "    - $file"
	done
	echo
	((pr_num++))
done

# Ask for confirmation
read -rp "Do you want to create branches and commit these files? (y/N) " confirm
if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
	echo "Aborted."
	exit 0
fi

# Ask for common commit message
read -rp "Enter common commit message: " COMMIT_MSG

# Create branches and commit files
pr_num=1
for group in "${PR_GROUPS[@]}"; do
	reviewers="${group%%|*}"
	files="${group#*|}"
	files_array=($files)

	# Ask for branch-specific postfix
	read -rp "Enter postfix for branch $pr_num (press enter for none): " POSTFIX
	branch_name="${BRANCH_PREFIX}"
	[[ -n "$POSTFIX" ]] && branch_name="${branch_name}/${POSTFIX}"

	# Create and checkout branch
	git checkout -b "$branch_name"

	# Add files and commit
	git add "${files_array[@]}"
	git commit -m "$COMMIT_MSG"

	# Switch back to main branch
	git checkout -
	((pr_num++))
done

echo "Branches created and commits done."
