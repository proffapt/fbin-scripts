#!/bin/bash

set -euo pipefail

# Generate UUIDv4
config_id=$(uuidgen | tr '[:upper:]' '[:lower:]')

# Prompt for missing values
prompt_if_missing() {
	local var_name="$1"
	local prompt_text="$2"

	if [ -z "${!var_name:-}" ]; then
		read -rp "$prompt_text: " val
		eval "$var_name=\"\$val\""
	fi
}

# Escape single quotes if not already escaped
escape_single_quotes() {
	perl -pe "s/(?<!')'(?!')/''/g"
}

# Parse CLI args
while [[ $# -gt 0 ]]; do
	case $1 in
	--source_entity_id)
		SOURCE_ENTITY_ID="$2"
		shift
		;;
	--organization_id)
		ORG_ID="$2"
		shift
		;;
	--program_name)
		PROGRAM_NAME="$2"
		shift
		;;
	--module_name)
		MODULE_NAME="$2"
		shift
		;;
	--workflow_definition)
		WORKFLOW_DEFINITION="$2"
		shift
		;;
	--deactivate-id)
		DEACTIVATE_ID="$2"
		shift
		;;
	--skip-update | --disable-update) DEACTIVATE_ID="skip" ;;
	*)
		echo "Unknown option: $1"
		exit 1
		;;
	esac
	shift
done

# Prompt if missing
if [ "${DEACTIVATE_ID:-}" != "skip" ] && [ "${DEACTIVATE_ID:-}" == "" ]; then
	prompt_if_missing DEACTIVATE_ID "Enter config_id to deactivate (press ENTER to skip)"
fi
prompt_if_missing SOURCE_ENTITY_ID "Enter source_entity_id"
prompt_if_missing ORG_ID "Enter organization_id"
prompt_if_missing PROGRAM_NAME "Enter program_name"
prompt_if_missing MODULE_NAME "Enter module_name"

if [ -z "${WORKFLOW_DEFINITION:-}" ]; then
	echo "No workflow_definition provided. Opening editor..."
	tmpfile=$(mktemp "/tmp/workflow_def.${config_id}.json")
	nvim "$tmpfile"
	WORKFLOW_DEFINITION=$(cat "$tmpfile")
	rm "$tmpfile"
fi

# Escape
ESCAPED_WORKFLOW_DEF=$(printf '%s' "$WORKFLOW_DEFINITION" | escape_single_quotes)

# SQL Generation
echo
if [ "${DEACTIVATE_ID:-}" != "skip" ] && [ "${DEACTIVATE_ID:-}" != "" ]; then
	cat <<EOF
-- Deactivate previous config:
UPDATE workflow_config
SET is_active = 'false'
WHERE config_id = '$DEACTIVATE_ID';

EOF
fi

cat <<EOF
-- INSERT new workflow_config:
INSERT INTO workflow_config (
    config_id,
    source_entity_id,
    organization_id,
    program_name,
    version,
    module_name,
    created_by,
    is_active,
    workflow_definition
)
VALUES (
    '$config_id',
    '$SOURCE_ENTITY_ID',
    '$ORG_ID',
    '$PROGRAM_NAME',
    (
        SELECT COALESCE(MAX(version), 0) + 1
        FROM workflow_config
        WHERE organization_id = '$ORG_ID'
          AND program_name = '$PROGRAM_NAME'
          AND module_name = '$MODULE_NAME'
    ),
    '$MODULE_NAME',
    'arpit.bhardwaj@finbox.in',
    true,
    '$ESCAPED_WORKFLOW_DEF'
);
EOF
